
# This file was generated by the Tkinter Designer by Parth Jadhav
# https://github.com/ParthJadhav/Tkinter-Designer


import os
from pathlib import Path


# from tkinter import *
# Explicit imports to satisfy Flake8
from tkinter import Tk, Canvas, Entry, Text, Button, PhotoImage
# Import libraries from ui_handle_data.py
import pandas as pd
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
from sklearn.preprocessing import MinMaxScaler
# ... other imports from ui_handle_data.py

# Import libraries from tkinter
import tkinter as tk
from tkinter import Tk, Canvas, Entry, Text, Button, PhotoImage, ttk

OUTPUT_PATH = Path(__file__).parent
ASSETS_PATH = OUTPUT_PATH / Path(r"/home/zahoree/workspace/build/assets/frame0")


os.environ["DATA_DIR"] = "/home/zahoree/workspace"

def relative_to_assets(path: str) -> Path:
    return ASSETS_PATH / Path(path)


def read_dataset(file_name):
    """
        Retrieves the csv file as a Pandas DataFrame
        returns a Pandas Dataframe
    """
    return pd.read_csv(file_name)

def user_data_full(file_name, df):
    """ Reads the user's dataset  """
    user_df = read_dataset(file_name)
    #   Fixing user dataframe columns
    user_df.columns = ["track_id", "track_name", "track_artist"]

    return user_df

def create_genre_feature_set(df, float_cols):
  """
  @brief Creates a feature set dataframe for genres by vectorizing them and adds scaled float columns and track_id to the new dataframe.

  @param df           Music dataframe
  @param float_cols   Floating value columns from dataframe

  @return Dataframe with genre features.
  """

  # Create a TfidfVectorizer for genre features
  vectorizer = TfidfVectorizer()
  tfid_matrix = vectorizer.fit_transform(df["playlist_genres"].apply(lambda x: ' '.join(x)))
  genre_df = pd.DataFrame(tfid_matrix.toarray())
  genre_df.columns = ['genre' + "|" + i for i in vectorizer.get_feature_names_out()]
  genre_df.reset_index(drop = True, inplace=True)

  # Scale float columns
  floats = df[float_cols].reset_index(drop=True)
  scaler = MinMaxScaler()
  scaled_float_df = pd.DataFrame(scaler.fit_transform(floats), columns=float_cols) * 0.2

  # Create a new DataFrame combining genre vectors and scaled float values
  new_df = pd.concat([genre_df, scaled_float_df], axis=1)
  new_df['track_id'] = df['track_id'].values
 # new_df['playlist_id'] = df['playlist_id']

  return new_df


def generate_playlist_feature_vector(user_df, feature_set_df):
  """
  @brief Generates a playlist feature vector by averaging the vector's features of liked user songs.

  @param user_df        User playlist dataframe 
  @param feature_set_df Feature dataframe 

  @return A playlist feature vector
  """
  # Looks for the user's songs in the playlist
  user_tracks_features = feature_set_df[feature_set_df['track_id'].isin(user_df['track_id'])]
  # Calculates the mean of the values of the song's vectors and stores it as a vector
  playlist_feature_vector = user_tracks_features.drop('track_id', axis=1).mean(axis=0).values

  return playlist_feature_vector



def generate_recommendation(playlist_vector, feature_set_df, df, top_n=15):
  """
  @brief  Generates music recommendations based on a playlist vector using cosine similarity.

  @param playlist_vector  Playlist Feature vector with user likeness.
  @param feature_set_df   Feature set dataframe.
  @param df               Spotify dataframe.
  @param top_n            Size of playlist.

  @returns DataFrame containing the top N recommended tracks.
  """

  # Remove track_id from the feature set
  feature_set_without_id = feature_set_df.drop('track_id', axis=1)

  # Calculate cosine similarity between the playlist vector and all tracks in the feature set
  similarity_scores = cosine_similarity(playlist_vector.reshape(1, -1), feature_set_without_id)

  # New dataframe with similarity score for each song
  similarity_df = pd.DataFrame({'track_id': feature_set_df['track_id'], 'similarity': similarity_scores[0]})

  # Sort the DataFrame by similarity score in descending order and recomend the highest score
  sorted_similarity_df = similarity_df.sort_values('similarity', ascending=False)
  top_n_recommendations = sorted_similarity_df.head(top_n)

  # Get metadata from spotify dataset
  recommended_tracks = pd.merge(top_n_recommendations, df, on='track_id', how='left')

  return recommended_tracks


def recommend_playlist_name(recomendations_df, top_n=1):
  """
  @brief Recommends a playlist.

  @param  playlist_vector   The playlist feature vector.
  @param  df                DataFrame containing the original track information.
  @param  top_n             Number of playlist names to recommend.

  @return A list of recommended playlist names.
  """
  # Sort the recomendation
  playlist_counts = recomendations_df.groupby('playlist_name').size().sort_values(ascending=False)

  # Playist recomendation
  return playlist_counts.index.tolist()[:top_n]


def user_recommendation_playlist_organized(df):
  return pd.DataFrame({"track_id": df["track_id"], "track_name": df["track_name"], "track_artist":df["track_artist"], "genres":df["playlist_genres"]})
   

def delete_null_data(df):
  """
    @brief Checks if there are null values in the data frame and deletes them.
    
    @param  df  Spotify Dataframe
    @return df  Dataframe without null values
  """
  #print(df.shape)
  # Finds null data
  null_mask = df.isnull().any(axis=1)
  #print(null_mask)
  # Deletes rows where there are null data
  df = df.dropna(axis=0, how='any')

  return df


df = read_dataset(os.environ["DATA_DIR"] +"/spotify_songs.csv")
df = delete_null_data(df)

  # Create a new column with a list of playlist_genre and playlist_subgenre
df['playlist_genres'] = df.apply(lambda row: [row['playlist_genre'], row['playlist_subgenre']], axis=1)

# Feature set data preparation
float_cols = df.dtypes[df.dtypes == 'float64'].index.values

# Apply the function to create the new dataframe
feature_set_df = create_genre_feature_set(df, float_cols)


def update_recommendations_tkinter():
  global feature_set_df 
  global df
  selected_user_file = user_file_dropdown.get()
  if selected_user_file:
    try:
      # Get selected user data
      user_df = user_data_full(selected_user_file, df)
      # Generate recommendations
      playlist_vector = generate_playlist_feature_vector(user_df, feature_set_df)
      recommendations_df = generate_recommendation(playlist_vector, feature_set_df, df)

      # Clear previous output
      recommendation_text.delete("1.0", tk.END)
      playlist_recommendation.delete("1.0", tk.END)

      # Display the recommended playlist name
      recommended_playlist_name_list = recommend_playlist_name(recommendations_df)
      # Display the recommended playlist
      if recommended_playlist_name_list:
        playlist_recommendation.insert(tk.END, f"{recommended_playlist_name_list[0]}\n\n")
      else:
        playlist_recommendation.insert(tk.END, "No playlist name recommendation found.\n\n")

      for index, row in recommendations_df[['track_name', 'track_artist']].head(10).iterrows():
        recommendation_text.insert(tk.END, f"- {row['track_name']} by {row['track_artist']}\n")

    except FileNotFoundError:
      recommendation_text.insert(tk.END, f"File '{selected_user_file}' not found.")
    except Exception as e:
      recommendation_text.insert(tk.END, f"An error occurred: {e}")




window = Tk()







window.geometry("600x400")
window.configure(bg = "#FFFFFF")


canvas = Canvas(
    window,
    bg = "#FFFFFF",
    height = 400,
    width = 600,
    bd = 0,
    highlightthickness = 0,
    relief = "ridge"
)

canvas.place(x = 0, y = 0)
canvas.create_rectangle(
    0.0,
    0.0,
    600.0,
    400.0,
    fill="#5A5A5A",
    outline="")

canvas.create_rectangle(
    0.0,
    0.0,
    275.0,
    400.0,
    fill="#667464",
    outline="")

canvas.create_text(
    35.0,
    25.0,
    anchor="nw",
    text="Music Recommender System",
    fill="#FFFFFF",
    font=("Inter Bold", 20 * -1)
)

canvas.create_text(
    19.0,
    157.0,
    anchor="nw",
    text="Select your favorite playlist",
    fill="#FFFFFF",
    font=("Inter Bold", 12 * -1)
)

canvas.create_text(
    19.0,
    233.0,
    anchor="nw",
    text="We recommend you the playlist",
    fill="#FFFFFF",
    font=("Inter Bold", 12 * -1)
)

button_image_1 = PhotoImage(
    file=relative_to_assets("button_1.png"))
button_1 = Button(
    window,
    image=button_image_1,
    borderwidth=0,
    highlightthickness=0,
    command=update_recommendations_tkinter,
    relief="flat"
)
button_1.place(
    x=218.0,
    y=175.0,
    width=49.0,
    height=19.0
)

entry_image_1 = PhotoImage(
    file=relative_to_assets("entry_1.png"))
entry_bg_1 = canvas.create_image(
    116.0,
    258.5,
    image=entry_image_1
)
playlist_recommendation = Text(
    bd=0,
    bg="#D9D9D9",
    fg="#000716",
    highlightthickness=0
)
playlist_recommendation.place(
    x=19.0,
    y=251.0,
    width=194.0,
    height=13.0
)

canvas.create_text(
    335.0,
    25.0,
    anchor="nw",
    text="Your new playlist is here",
    fill="#FFFFFF",
    font=("Inter Bold", 20 * -1)
)

canvas.create_rectangle(
    294.0,
    92.0,
    583.0,
    379.0,
    fill="#D9D9D9",
    outline="")

canvas.create_text(
    310.0,
    103.0,
    anchor="nw",
    text="Song",
    fill="#000000",
    font=("Inter Bold", 12 * -1)
)

canvas.create_text(
    425.0,
    103.0,
    anchor="nw",
    text="Artist",
    fill="#000000",
    font=("Inter Bold", 12 * -1)
)

canvas.create_text(
    523.0,
    103.0,
    anchor="nw",
    text="Genre",
    fill="#000000",
    font=("Inter Bold", 12 * -1)
)

button_image_2 = PhotoImage(
    file=relative_to_assets("button_2.png"))
user_file_dropdown = ttk.Combobox(
    window,
    values=[os.environ["DATA_DIR"] + "/User_A.csv",
                                                    os.environ["DATA_DIR"] + "/User_B.csv",
                                                    os.environ["DATA_DIR"] + "/User_J.csv",
                                                    os.environ["DATA_DIR"] + "/User_O.csv"],
)
user_file_dropdown.place(
    x=19.0,
    y=175.0,
    width=194.0,
    height=19.0
)



entry_image_2 = PhotoImage(
    file=relative_to_assets("entry_2.png"))
entry_bg_2 = canvas.create_image(
    439.0,
    253.5,
    image=entry_image_2
)
recommendation_text = Text(
    bd=0,
    bg="#A6AFA5",
    fg="#000716",
    highlightthickness=0
)
recommendation_text.place(
    x=307.0,
    y=139.0,
    width=264.0,
    height=227.0
)



window.resizable(False, False)
window.mainloop()
